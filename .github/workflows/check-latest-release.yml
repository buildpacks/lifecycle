name: Check latest lifecycle release
"on":
    schedule:
        - cron: 0 2 * * 1,4
    workflow_dispatch: {}
jobs:
    update:
        name: Check go version
        runs-on:
            - ubuntu-latest
        steps:
            - uses: actions/setup-go@v3
              with:
                go-version: "1.18"
            - uses: actions/checkout@v3
            - name: Read go versions
              id: read-go
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                #!/usr/bin/env bash

                set -euo pipefail

                LATEST_GO_VERSION=$(go version | cut -d ' ' -f 3)

                LATEST_RELEASE_VERSION=$(gh release list -L 1 | cut -d $'\t' -f 1 | cut -d ' ' -f 2)

                wget https://github.com/buildpacks/lifecycle/releases/download/$LATEST_RELEASE_VERSION/lifecycle-$LATEST_RELEASE_VERSION+linux.x86-64.tgz -O lifecycle.tgz
                tar xzf lifecycle.tgz
                LATEST_RELEASE_GO_VERSION=$(go version ./lifecycle/lifecycle | cut -d ' ' -f 2)

                echo "::set-output name=latest-go-version::${LATEST_GO_VERSION}"
                echo "::set-output name=latest-release-go-version::${LATEST_RELEASE_GO_VERSION}"
                echo "::set-output name=latest-release-version::${LATEST_RELEASE_VERSION}"
            - name: Create issue if needed
              if: ${{ steps.read-go.outputs.latest-go-version != steps.read-go.outputs.latest-release-go-version }}
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                #!/usr/bin/env bash

                set -euo pipefail

                gh issue create \
                  --label "type/bug" \
                  --label "status/triage" \
                  --body "Latest lifecycle release is built with Go version ${{ steps.read-go.outputs.latest-release-go-version }}; newer version ${{ steps.read-go.outputs.latest-go-version }} is available." \
                  --title "Upgrade lifecycle to latest version of Go 1.18.x"
            - name: Scan latest release image
              uses: anchore/scan-action@v3
              with:
                image: buildpacksio/lifecycle:${{ steps.read-go.outputs.latest-release-version }}
